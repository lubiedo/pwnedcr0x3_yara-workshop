#include <time.h>
#include <stdio.h>
#include <fcntl.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/prctl.h>

const static char secret[] = {
  0x19, 0x1e, 0x07, 0x0c, 0x0d, 0x0a, 0x1b, 0x5b, 0x59, 0x5b, 0x59, 0x69
};

#ifndef NOSTRINGS
const char data[] = "this is some malicious data! w00t w00t!";
const char ext[]  = {'.', 'b', 'a', 'd', '\0'};
#endif

static void
clean(const char *file)
{
  unlink(file);
}

#ifndef NOSTRINGS
static void
change_procname()
{
  const char names[3][10] = {
    {'s','s','h','\0'},
    {'i','n','i','t','\0'},
    {'d','r','o','p','b','e','a','r','\0'}
  };

  prctl(PR_SET_NAME, names[rand()%3]);
}
#endif

static void
main_loop() {
#ifndef NOSTRINGS
  char name[15];

  strcpy(name, "/tmp/");
  /* generate random name */
  for (short int i = 5; i < 10;i++) {
    short int n = (short int)(rand() % 27);
    name[i] = n + ((n % 2) ? 'A' : 'a');
  }
  strcpy(name + 10, ext);

  /* open the new file and save da stuff */
  int new_fd = open(name, O_CREAT|O_WRONLY, 0400);
  if (new_fd < 0)
    exit(-1);

  write(new_fd, (const void *)data, strlen(data));
  close(new_fd);
#endif
  for(;;) {
    for (short int i = 0;;i++) {
      char c = secret[i] ^ 0x69;
      if (c == '\0')
        break;
      putchar(c);
    }
    putchar('\n');
    fflush(stdout);
    sleep(5);
  }
}

int
main (int argc, char **argv)
{
  srand(time(NULL));
  /* erase evidence and live in memory */
  clean(argv[0]);
#ifndef NOSTRINGS
  /* disguise */
  change_procname();
#endif
  /* run for ever! */
  main_loop();
  return 0;
}
